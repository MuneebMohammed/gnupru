From 09a7faae849c955af5df2ac429cfcbb5006358de Mon Sep 17 00:00:00 2001
From: Dimitar Dimitrov <dimitar@dinux.eu>
Date: Mon, 11 Dec 2017 21:20:49 +0200
Subject: [PATCH 4/4] Align linker scripts

Signed-off-by: Dimitar Dimitrov <dimitar@dinux.eu>
---
 libgloss/pru/ldscripts/pruelf-am335x.pru0.x       | 13 +++++++++++++
 libgloss/pru/ldscripts/pruelf-am335x.pru1.x       | 13 +++++++++++++
 libgloss/pru/ldscripts/pruelf-am437x.icss0.pru0.x | 13 +++++++++++++
 libgloss/pru/ldscripts/pruelf-am437x.icss0.pru1.x | 13 +++++++++++++
 libgloss/pru/ldscripts/pruelf-am437x.icss1.pru0.x | 13 +++++++++++++
 libgloss/pru/ldscripts/pruelf-am437x.icss1.pru1.x | 13 +++++++++++++
 libgloss/pru/ldscripts/pruelf-sim.x               | 13 +++++++++++++
 7 files changed, 91 insertions(+)

diff --git a/libgloss/pru/ldscripts/pruelf-am335x.pru0.x b/libgloss/pru/ldscripts/pruelf-am335x.pru0.x
index 6af7477bb..e52f8f7ad 100644
--- a/libgloss/pru/ldscripts/pruelf-am335x.pru0.x
+++ b/libgloss/pru/ldscripts/pruelf-am335x.pru0.x
@@ -12,6 +12,8 @@ MEMORY
 }
 __HEAP_SIZE = DEFINED(__HEAP_SIZE) ? __HEAP_SIZE : 32 ;
 __STACK_SIZE = DEFINED(__STACK_SIZE) ? __STACK_SIZE : 512 ;
+/* For compatibility with TI's toolchain.  */
+__SYSMEM_SIZE = __HEAP_SIZE;
  PROVIDE (_stack_top = ORIGIN(dmem) + LENGTH(dmem)) ;
 ENTRY (_start)
 SECTIONS
@@ -29,12 +31,14 @@ SECTIONS
     {
       *(.rel.text)
       *(.rel.text.*)
+      *(.rel.text:*)
       *(.rel.gnu.linkonce.t*)
     }
   .rela.text     :
     {
       *(.rela.text)
       *(.rela.text.*)
+      *(.rela.text:*)
       *(.rela.gnu.linkonce.t*)
     }
   .rel.fini      : { *(.rel.fini)		}
@@ -43,24 +47,28 @@ SECTIONS
     {
       *(.rel.rodata)
       *(.rel.rodata.*)
+      *(.rel.rodata:*)
       *(.rel.gnu.linkonce.r*)
     }
   .rela.rodata   :
     {
       *(.rela.rodata)
       *(.rela.rodata.*)
+      *(.rela.rodata:*)
       *(.rela.gnu.linkonce.r*)
     }
   .rel.data      :
     {
       *(.rel.data)
       *(.rel.data.*)
+      *(.rel.data:*)
       *(.rel.gnu.linkonce.d*)
     }
   .rela.data     :
     {
       *(.rela.data)
       *(.rela.data.*)
+      *(.rela.data:*)
       *(.rela.gnu.linkonce.d*)
     }
   .rel.ctors     : { *(.rel.ctors)	}
@@ -85,6 +93,8 @@ SECTIONS
     . = ALIGN(4);
     *(.text.*)
     . = ALIGN(4);
+    *(.text:*)
+    . = ALIGN(4);
     *(.gnu.linkonce.t*)
     . = ALIGN(4);
      _text_end = . ;
@@ -111,8 +121,10 @@ SECTIONS
      PROVIDE (_data_start = .) ;
     *(.data)
      *(.data*)
+     *(.data:*)
      *(.rodata)  /* We need to include .rodata here if gcc is used.  */
      *(.rodata.*) /* with -fdata-sections.  */
+     *(.rodata:*)
     *(.gnu.linkonce.d*)
     *(.gnu.linkonce.r*)
     . = ALIGN(4);
@@ -128,6 +140,7 @@ SECTIONS
      PROVIDE (_bss_start = .) ;
     *(.bss)
      *(.bss.*)
+     *(.bss:*)
     *(.gnu.linkonce.b*)
     *(COMMON)
      PROVIDE (_bss_end = .) ;
diff --git a/libgloss/pru/ldscripts/pruelf-am335x.pru1.x b/libgloss/pru/ldscripts/pruelf-am335x.pru1.x
index 6af7477bb..e52f8f7ad 100644
--- a/libgloss/pru/ldscripts/pruelf-am335x.pru1.x
+++ b/libgloss/pru/ldscripts/pruelf-am335x.pru1.x
@@ -12,6 +12,8 @@ MEMORY
 }
 __HEAP_SIZE = DEFINED(__HEAP_SIZE) ? __HEAP_SIZE : 32 ;
 __STACK_SIZE = DEFINED(__STACK_SIZE) ? __STACK_SIZE : 512 ;
+/* For compatibility with TI's toolchain.  */
+__SYSMEM_SIZE = __HEAP_SIZE;
  PROVIDE (_stack_top = ORIGIN(dmem) + LENGTH(dmem)) ;
 ENTRY (_start)
 SECTIONS
@@ -29,12 +31,14 @@ SECTIONS
     {
       *(.rel.text)
       *(.rel.text.*)
+      *(.rel.text:*)
       *(.rel.gnu.linkonce.t*)
     }
   .rela.text     :
     {
       *(.rela.text)
       *(.rela.text.*)
+      *(.rela.text:*)
       *(.rela.gnu.linkonce.t*)
     }
   .rel.fini      : { *(.rel.fini)		}
@@ -43,24 +47,28 @@ SECTIONS
     {
       *(.rel.rodata)
       *(.rel.rodata.*)
+      *(.rel.rodata:*)
       *(.rel.gnu.linkonce.r*)
     }
   .rela.rodata   :
     {
       *(.rela.rodata)
       *(.rela.rodata.*)
+      *(.rela.rodata:*)
       *(.rela.gnu.linkonce.r*)
     }
   .rel.data      :
     {
       *(.rel.data)
       *(.rel.data.*)
+      *(.rel.data:*)
       *(.rel.gnu.linkonce.d*)
     }
   .rela.data     :
     {
       *(.rela.data)
       *(.rela.data.*)
+      *(.rela.data:*)
       *(.rela.gnu.linkonce.d*)
     }
   .rel.ctors     : { *(.rel.ctors)	}
@@ -85,6 +93,8 @@ SECTIONS
     . = ALIGN(4);
     *(.text.*)
     . = ALIGN(4);
+    *(.text:*)
+    . = ALIGN(4);
     *(.gnu.linkonce.t*)
     . = ALIGN(4);
      _text_end = . ;
@@ -111,8 +121,10 @@ SECTIONS
      PROVIDE (_data_start = .) ;
     *(.data)
      *(.data*)
+     *(.data:*)
      *(.rodata)  /* We need to include .rodata here if gcc is used.  */
      *(.rodata.*) /* with -fdata-sections.  */
+     *(.rodata:*)
     *(.gnu.linkonce.d*)
     *(.gnu.linkonce.r*)
     . = ALIGN(4);
@@ -128,6 +140,7 @@ SECTIONS
      PROVIDE (_bss_start = .) ;
     *(.bss)
      *(.bss.*)
+     *(.bss:*)
     *(.gnu.linkonce.b*)
     *(COMMON)
      PROVIDE (_bss_end = .) ;
diff --git a/libgloss/pru/ldscripts/pruelf-am437x.icss0.pru0.x b/libgloss/pru/ldscripts/pruelf-am437x.icss0.pru0.x
index 3a3cd94ae..b66963c2e 100644
--- a/libgloss/pru/ldscripts/pruelf-am437x.icss0.pru0.x
+++ b/libgloss/pru/ldscripts/pruelf-am437x.icss0.pru0.x
@@ -12,6 +12,8 @@ MEMORY
 }
 __HEAP_SIZE = DEFINED(__HEAP_SIZE) ? __HEAP_SIZE : 32 ;
 __STACK_SIZE = DEFINED(__STACK_SIZE) ? __STACK_SIZE : 256 ;
+/* For compatibility with TI's toolchain.  */
+__SYSMEM_SIZE = __HEAP_SIZE;
  PROVIDE (_stack_top = ORIGIN(dmem) + LENGTH(dmem)) ;
 ENTRY (_start)
 SECTIONS
@@ -29,12 +31,14 @@ SECTIONS
     {
       *(.rel.text)
       *(.rel.text.*)
+      *(.rel.text:*)
       *(.rel.gnu.linkonce.t*)
     }
   .rela.text     :
     {
       *(.rela.text)
       *(.rela.text.*)
+      *(.rela.text:*)
       *(.rela.gnu.linkonce.t*)
     }
   .rel.fini      : { *(.rel.fini)		}
@@ -43,24 +47,28 @@ SECTIONS
     {
       *(.rel.rodata)
       *(.rel.rodata.*)
+      *(.rel.rodata:*)
       *(.rel.gnu.linkonce.r*)
     }
   .rela.rodata   :
     {
       *(.rela.rodata)
       *(.rela.rodata.*)
+      *(.rela.rodata:*)
       *(.rela.gnu.linkonce.r*)
     }
   .rel.data      :
     {
       *(.rel.data)
       *(.rel.data.*)
+      *(.rel.data:*)
       *(.rel.gnu.linkonce.d*)
     }
   .rela.data     :
     {
       *(.rela.data)
       *(.rela.data.*)
+      *(.rela.data:*)
       *(.rela.gnu.linkonce.d*)
     }
   .rel.ctors     : { *(.rel.ctors)	}
@@ -85,6 +93,8 @@ SECTIONS
     . = ALIGN(4);
     *(.text.*)
     . = ALIGN(4);
+    *(.text:*)
+    . = ALIGN(4);
     *(.gnu.linkonce.t*)
     . = ALIGN(4);
      _text_end = . ;
@@ -111,8 +121,10 @@ SECTIONS
      PROVIDE (_data_start = .) ;
     *(.data)
      *(.data*)
+     *(.data:*)
      *(.rodata)  /* We need to include .rodata here if gcc is used.  */
      *(.rodata.*) /* with -fdata-sections.  */
+     *(.rodata:*)
     *(.gnu.linkonce.d*)
     *(.gnu.linkonce.r*)
     . = ALIGN(4);
@@ -128,6 +140,7 @@ SECTIONS
      PROVIDE (_bss_start = .) ;
     *(.bss)
      *(.bss.*)
+     *(.bss:*)
     *(.gnu.linkonce.b*)
     *(COMMON)
      PROVIDE (_bss_end = .) ;
diff --git a/libgloss/pru/ldscripts/pruelf-am437x.icss0.pru1.x b/libgloss/pru/ldscripts/pruelf-am437x.icss0.pru1.x
index 3a3cd94ae..b66963c2e 100644
--- a/libgloss/pru/ldscripts/pruelf-am437x.icss0.pru1.x
+++ b/libgloss/pru/ldscripts/pruelf-am437x.icss0.pru1.x
@@ -12,6 +12,8 @@ MEMORY
 }
 __HEAP_SIZE = DEFINED(__HEAP_SIZE) ? __HEAP_SIZE : 32 ;
 __STACK_SIZE = DEFINED(__STACK_SIZE) ? __STACK_SIZE : 256 ;
+/* For compatibility with TI's toolchain.  */
+__SYSMEM_SIZE = __HEAP_SIZE;
  PROVIDE (_stack_top = ORIGIN(dmem) + LENGTH(dmem)) ;
 ENTRY (_start)
 SECTIONS
@@ -29,12 +31,14 @@ SECTIONS
     {
       *(.rel.text)
       *(.rel.text.*)
+      *(.rel.text:*)
       *(.rel.gnu.linkonce.t*)
     }
   .rela.text     :
     {
       *(.rela.text)
       *(.rela.text.*)
+      *(.rela.text:*)
       *(.rela.gnu.linkonce.t*)
     }
   .rel.fini      : { *(.rel.fini)		}
@@ -43,24 +47,28 @@ SECTIONS
     {
       *(.rel.rodata)
       *(.rel.rodata.*)
+      *(.rel.rodata:*)
       *(.rel.gnu.linkonce.r*)
     }
   .rela.rodata   :
     {
       *(.rela.rodata)
       *(.rela.rodata.*)
+      *(.rela.rodata:*)
       *(.rela.gnu.linkonce.r*)
     }
   .rel.data      :
     {
       *(.rel.data)
       *(.rel.data.*)
+      *(.rel.data:*)
       *(.rel.gnu.linkonce.d*)
     }
   .rela.data     :
     {
       *(.rela.data)
       *(.rela.data.*)
+      *(.rela.data:*)
       *(.rela.gnu.linkonce.d*)
     }
   .rel.ctors     : { *(.rel.ctors)	}
@@ -85,6 +93,8 @@ SECTIONS
     . = ALIGN(4);
     *(.text.*)
     . = ALIGN(4);
+    *(.text:*)
+    . = ALIGN(4);
     *(.gnu.linkonce.t*)
     . = ALIGN(4);
      _text_end = . ;
@@ -111,8 +121,10 @@ SECTIONS
      PROVIDE (_data_start = .) ;
     *(.data)
      *(.data*)
+     *(.data:*)
      *(.rodata)  /* We need to include .rodata here if gcc is used.  */
      *(.rodata.*) /* with -fdata-sections.  */
+     *(.rodata:*)
     *(.gnu.linkonce.d*)
     *(.gnu.linkonce.r*)
     . = ALIGN(4);
@@ -128,6 +140,7 @@ SECTIONS
      PROVIDE (_bss_start = .) ;
     *(.bss)
      *(.bss.*)
+     *(.bss:*)
     *(.gnu.linkonce.b*)
     *(COMMON)
      PROVIDE (_bss_end = .) ;
diff --git a/libgloss/pru/ldscripts/pruelf-am437x.icss1.pru0.x b/libgloss/pru/ldscripts/pruelf-am437x.icss1.pru0.x
index 6af7477bb..e52f8f7ad 100644
--- a/libgloss/pru/ldscripts/pruelf-am437x.icss1.pru0.x
+++ b/libgloss/pru/ldscripts/pruelf-am437x.icss1.pru0.x
@@ -12,6 +12,8 @@ MEMORY
 }
 __HEAP_SIZE = DEFINED(__HEAP_SIZE) ? __HEAP_SIZE : 32 ;
 __STACK_SIZE = DEFINED(__STACK_SIZE) ? __STACK_SIZE : 512 ;
+/* For compatibility with TI's toolchain.  */
+__SYSMEM_SIZE = __HEAP_SIZE;
  PROVIDE (_stack_top = ORIGIN(dmem) + LENGTH(dmem)) ;
 ENTRY (_start)
 SECTIONS
@@ -29,12 +31,14 @@ SECTIONS
     {
       *(.rel.text)
       *(.rel.text.*)
+      *(.rel.text:*)
       *(.rel.gnu.linkonce.t*)
     }
   .rela.text     :
     {
       *(.rela.text)
       *(.rela.text.*)
+      *(.rela.text:*)
       *(.rela.gnu.linkonce.t*)
     }
   .rel.fini      : { *(.rel.fini)		}
@@ -43,24 +47,28 @@ SECTIONS
     {
       *(.rel.rodata)
       *(.rel.rodata.*)
+      *(.rel.rodata:*)
       *(.rel.gnu.linkonce.r*)
     }
   .rela.rodata   :
     {
       *(.rela.rodata)
       *(.rela.rodata.*)
+      *(.rela.rodata:*)
       *(.rela.gnu.linkonce.r*)
     }
   .rel.data      :
     {
       *(.rel.data)
       *(.rel.data.*)
+      *(.rel.data:*)
       *(.rel.gnu.linkonce.d*)
     }
   .rela.data     :
     {
       *(.rela.data)
       *(.rela.data.*)
+      *(.rela.data:*)
       *(.rela.gnu.linkonce.d*)
     }
   .rel.ctors     : { *(.rel.ctors)	}
@@ -85,6 +93,8 @@ SECTIONS
     . = ALIGN(4);
     *(.text.*)
     . = ALIGN(4);
+    *(.text:*)
+    . = ALIGN(4);
     *(.gnu.linkonce.t*)
     . = ALIGN(4);
      _text_end = . ;
@@ -111,8 +121,10 @@ SECTIONS
      PROVIDE (_data_start = .) ;
     *(.data)
      *(.data*)
+     *(.data:*)
      *(.rodata)  /* We need to include .rodata here if gcc is used.  */
      *(.rodata.*) /* with -fdata-sections.  */
+     *(.rodata:*)
     *(.gnu.linkonce.d*)
     *(.gnu.linkonce.r*)
     . = ALIGN(4);
@@ -128,6 +140,7 @@ SECTIONS
      PROVIDE (_bss_start = .) ;
     *(.bss)
      *(.bss.*)
+     *(.bss:*)
     *(.gnu.linkonce.b*)
     *(COMMON)
      PROVIDE (_bss_end = .) ;
diff --git a/libgloss/pru/ldscripts/pruelf-am437x.icss1.pru1.x b/libgloss/pru/ldscripts/pruelf-am437x.icss1.pru1.x
index 6af7477bb..e52f8f7ad 100644
--- a/libgloss/pru/ldscripts/pruelf-am437x.icss1.pru1.x
+++ b/libgloss/pru/ldscripts/pruelf-am437x.icss1.pru1.x
@@ -12,6 +12,8 @@ MEMORY
 }
 __HEAP_SIZE = DEFINED(__HEAP_SIZE) ? __HEAP_SIZE : 32 ;
 __STACK_SIZE = DEFINED(__STACK_SIZE) ? __STACK_SIZE : 512 ;
+/* For compatibility with TI's toolchain.  */
+__SYSMEM_SIZE = __HEAP_SIZE;
  PROVIDE (_stack_top = ORIGIN(dmem) + LENGTH(dmem)) ;
 ENTRY (_start)
 SECTIONS
@@ -29,12 +31,14 @@ SECTIONS
     {
       *(.rel.text)
       *(.rel.text.*)
+      *(.rel.text:*)
       *(.rel.gnu.linkonce.t*)
     }
   .rela.text     :
     {
       *(.rela.text)
       *(.rela.text.*)
+      *(.rela.text:*)
       *(.rela.gnu.linkonce.t*)
     }
   .rel.fini      : { *(.rel.fini)		}
@@ -43,24 +47,28 @@ SECTIONS
     {
       *(.rel.rodata)
       *(.rel.rodata.*)
+      *(.rel.rodata:*)
       *(.rel.gnu.linkonce.r*)
     }
   .rela.rodata   :
     {
       *(.rela.rodata)
       *(.rela.rodata.*)
+      *(.rela.rodata:*)
       *(.rela.gnu.linkonce.r*)
     }
   .rel.data      :
     {
       *(.rel.data)
       *(.rel.data.*)
+      *(.rel.data:*)
       *(.rel.gnu.linkonce.d*)
     }
   .rela.data     :
     {
       *(.rela.data)
       *(.rela.data.*)
+      *(.rela.data:*)
       *(.rela.gnu.linkonce.d*)
     }
   .rel.ctors     : { *(.rel.ctors)	}
@@ -85,6 +93,8 @@ SECTIONS
     . = ALIGN(4);
     *(.text.*)
     . = ALIGN(4);
+    *(.text:*)
+    . = ALIGN(4);
     *(.gnu.linkonce.t*)
     . = ALIGN(4);
      _text_end = . ;
@@ -111,8 +121,10 @@ SECTIONS
      PROVIDE (_data_start = .) ;
     *(.data)
      *(.data*)
+     *(.data:*)
      *(.rodata)  /* We need to include .rodata here if gcc is used.  */
      *(.rodata.*) /* with -fdata-sections.  */
+     *(.rodata:*)
     *(.gnu.linkonce.d*)
     *(.gnu.linkonce.r*)
     . = ALIGN(4);
@@ -128,6 +140,7 @@ SECTIONS
      PROVIDE (_bss_start = .) ;
     *(.bss)
      *(.bss.*)
+     *(.bss:*)
     *(.gnu.linkonce.b*)
     *(COMMON)
      PROVIDE (_bss_end = .) ;
diff --git a/libgloss/pru/ldscripts/pruelf-sim.x b/libgloss/pru/ldscripts/pruelf-sim.x
index 68a5f5ac1..f00f4f4e0 100644
--- a/libgloss/pru/ldscripts/pruelf-sim.x
+++ b/libgloss/pru/ldscripts/pruelf-sim.x
@@ -12,6 +12,8 @@ MEMORY
 }
 __HEAP_SIZE = DEFINED(__HEAP_SIZE) ? __HEAP_SIZE : 32 * 1024 * 1024 ;
 __STACK_SIZE = DEFINED(__STACK_SIZE) ? __STACK_SIZE : 1024 * 1024 ;
+/* For compatibility with TI's toolchain.  */
+__SYSMEM_SIZE = __HEAP_SIZE;
  PROVIDE (_stack_top = ORIGIN(dmem) + LENGTH(dmem)) ;
 ENTRY (_start)
 SECTIONS
@@ -29,12 +31,14 @@ SECTIONS
     {
       *(.rel.text)
       *(.rel.text.*)
+      *(.rel.text:*)
       *(.rel.gnu.linkonce.t*)
     }
   .rela.text     :
     {
       *(.rela.text)
       *(.rela.text.*)
+      *(.rela.text:*)
       *(.rela.gnu.linkonce.t*)
     }
   .rel.fini      : { *(.rel.fini)		}
@@ -43,24 +47,28 @@ SECTIONS
     {
       *(.rel.rodata)
       *(.rel.rodata.*)
+      *(.rel.rodata:*)
       *(.rel.gnu.linkonce.r*)
     }
   .rela.rodata   :
     {
       *(.rela.rodata)
       *(.rela.rodata.*)
+      *(.rela.rodata:*)
       *(.rela.gnu.linkonce.r*)
     }
   .rel.data      :
     {
       *(.rel.data)
       *(.rel.data.*)
+      *(.rel.data:*)
       *(.rel.gnu.linkonce.d*)
     }
   .rela.data     :
     {
       *(.rela.data)
       *(.rela.data.*)
+      *(.rela.data:*)
       *(.rela.gnu.linkonce.d*)
     }
   .rel.ctors     : { *(.rel.ctors)	}
@@ -85,6 +93,8 @@ SECTIONS
     . = ALIGN(4);
     *(.text.*)
     . = ALIGN(4);
+    *(.text:*)
+    . = ALIGN(4);
     *(.gnu.linkonce.t*)
     . = ALIGN(4);
      _text_end = . ;
@@ -111,8 +121,10 @@ SECTIONS
      PROVIDE (_data_start = .) ;
     *(.data)
      *(.data*)
+     *(.data:*)
      *(.rodata)  /* We need to include .rodata here if gcc is used.  */
      *(.rodata.*) /* with -fdata-sections.  */
+     *(.rodata:*)
     *(.gnu.linkonce.d*)
     *(.gnu.linkonce.r*)
     . = ALIGN(4);
@@ -128,6 +140,7 @@ SECTIONS
      PROVIDE (_bss_start = .) ;
     *(.bss)
      *(.bss.*)
+     *(.bss:*)
     *(.gnu.linkonce.b*)
     *(COMMON)
      PROVIDE (_bss_end = .) ;
-- 
2.11.0

