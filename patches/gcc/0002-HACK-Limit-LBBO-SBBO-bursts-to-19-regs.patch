From 4c7271ef172259d6834efcdbeba2d071168ac0f9 Mon Sep 17 00:00:00 2001
From: Dimitar Dimitrov <dimitar@dinux.eu>
Date: Mon, 28 Jul 2014 23:10:08 +0300
Subject: [PATCH 02/14] HACK: Limit LBBO/SBBO bursts to 19 regs

Until gcc/genextract.c is fixed to work with gargantuan
machine-generated insn patterns, limit PRU bursts to 19 registers.

Signed-off-by: Dimitar Dimitrov <dimitar@dinux.eu>
---
 gcc/config/pru/pru-ldst-multiple.ml | 2 +-
 gcc/config/pru/pru.md               | 7 +++++++
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/gcc/config/pru/pru-ldst-multiple.ml b/gcc/config/pru/pru-ldst-multiple.ml
index dc58acafbc0..23747a37e96 100644
--- a/gcc/config/pru/pru-ldst-multiple.ml
+++ b/gcc/config/pru/pru-ldst-multiple.ml
@@ -105,7 +105,7 @@ let write_pattern_1 name ls nregs do_first_offs write_set_fn =
 let patterns () =
   (* The rule for load-multiple of a single register greatly simplifies
      the prologue/epilogue code.  *)
-  for nregs = 1 to 29; do
+  for nregs = 1 to 19; do
     write_pattern_1 "lbbo" "load" nregs true write_ldm_set;
     write_pattern_1 "lbbo" "load" nregs false write_ldm_set;
     write_pattern_1 "sbbo" "store" nregs true write_stm_set;
diff --git a/gcc/config/pru/pru.md b/gcc/config/pru/pru.md
index 7546d70e689..c869d36608e 100644
--- a/gcc/config/pru/pru.md
+++ b/gcc/config/pru/pru.md
@@ -42,6 +42,11 @@
    (FRAME_POINTER_REGNUM	33)
    (ARG_POINTER_REGNUM		34)
    (FIRST_PSEUDO_REGISTER	35)
+
+   ;; Misc
+   (MAX_XBBO_BURST_LEN	    20)	; Artificially limited by GCC - see how
+				; genextract.c uses 'a'..'z' to record
+				; "path to a vector".
   ]
 )
 
@@ -193,6 +198,7 @@
      only if at least one register.  */
   if (GET_CODE (operands[2]) != CONST_INT
       || INTVAL (operands[2]) < 1
+      || INTVAL (operands[2]) > MAX_XBBO_BURST_LEN
       || GET_CODE (operands[1]) != MEM
       || GET_CODE (operands[0]) != REG
       || (REGNO (operands[0]) + INTVAL (operands[2]) - 1) > LAST_NONIO_GP_REG)
@@ -229,6 +235,7 @@
      only if at least one register.  */
   if (GET_CODE (operands[2]) != CONST_INT
       || INTVAL (operands[2]) < 1
+      || INTVAL (operands[2]) > MAX_XBBO_BURST_LEN
       || GET_CODE (operands[0]) != MEM
       || GET_CODE (operands[1]) != REG
       || (REGNO (operands[1]) + INTVAL (operands[2]) - 1) > LAST_NONIO_GP_REG)
-- 
2.11.0

